<div class="professional-patient-detail">
  <!-- Header with back button -->
  <div class="page-header">
    <button mat-icon-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-content">
      <h1>Historia Cl√≠nica del Paciente</h1>
      <p class="subtitle">Gesti√≥n de atenciones m√©dicas</p>
    </div>
  </div>

  <!-- Privacy Disclaimer (if applicable) -->
  @if (showPrivacyDisclaimer()) {
  <mat-card class="disclaimer-card">
    <mat-card-content>
      <mat-icon>info</mat-icon>
      <div class="disclaimer-text">
        <strong>Informaci√≥n de Privacidad</strong>
        <p>
          Por preferencia de privacidad del paciente, solo ves las atenciones
          que has registrado.
        </p>
      </div>
    </mat-card-content>
  </mat-card>
  }

  <!-- Tabs -->
  <mat-tab-group class="patient-tabs" animationDuration="300ms">
    <!-- Tab: Resumen -->
    <mat-tab label="Resumen">
      <div class="tab-content">
        <p class="placeholder-text">üèóÔ∏è Pr√≥ximamente: Resumen del paciente</p>
      </div>
    </mat-tab>

    <!-- Tab: Historia -->
    <mat-tab label="Historia">
      <div class="tab-content history-tab">
        <!-- Action Bar -->
        <div class="action-bar">
          <button mat-raised-button color="primary" (click)="createEncounter()">
            <mat-icon>add</mat-icon>
            Nueva Atenci√≥n
          </button>
        </div>

        <!-- Loading State -->
        @if (isLoading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Cargando historia cl√≠nica...</p>
        </div>
        }

        <!-- Error State -->
        @else if (error()) {
        <mat-card class="error-card">
          <mat-card-content>
            <mat-icon class="error-icon">error_outline</mat-icon>
            <p class="error-message">{{ error() }}</p>
            <button mat-raised-button color="primary" (click)="retry()">
              Reintentar
            </button>
          </mat-card-content>
        </mat-card>
        }

        <!-- Empty State -->
        @else if (encounters().length === 0) {
        <mat-card class="empty-card">
          <mat-card-content>
            <mat-icon class="empty-icon">medical_information</mat-icon>
            <p class="empty-message">A√∫n no hay atenciones registradas</p>
            <p class="empty-subtitle">
              Crea la primera atenci√≥n m√©dica para este paciente
            </p>
            <button
              mat-raised-button
              color="primary"
              (click)="createEncounter()"
            >
              <mat-icon>add</mat-icon>
              Crear Primera Atenci√≥n
            </button>
          </mat-card-content>
        </mat-card>
        }

        <!-- Content -->
        @else {
        <div class="encounters-list">
          @for (encounter of encounters(); track encounter.id) {
          <mat-card class="encounter-card">
            <mat-card-header>
              <mat-card-title>
                <div class="encounter-title">
                  <span class="date">
                    <mat-icon>event</mat-icon>
                    {{ encounter.encounterDateUtc | date: 'dd/MM/yyyy' }}
                  </span>
                  <span
                    class="status"
                    [class.draft]="encounter.status === 'Draft'"
                    [class.closed]="encounter.status === 'Closed'"
                  >
                    {{ encounter.status === 'Draft' ? 'Borrador' : 'Cerrada' }}
                  </span>
                  @if (!encounter.isOwnEncounter) {
                  <span
                    class="own-indicator"
                    matTooltip="Atenci√≥n de otro profesional"
                  >
                    <mat-icon>info</mat-icon>
                  </span>
                  }
                </div>
              </mat-card-title>
              <mat-card-subtitle>
                <div class="professional-info">
                  <mat-icon>person</mat-icon>
                  {{ encounter.professionalName }}
                </div>
              </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              @if (encounter.summary) {
              <div class="encounter-summary">
                <strong>Resumen:</strong>
                <p>{{ encounter.summary }}</p>
              </div>
              <mat-divider></mat-divider>
              }

              <!-- Notes -->
              <div class="notes-section">
                <h4>Notas Cl√≠nicas ({{ encounter.notesCount }})</h4>
                <p class="notes-preview">
                  Haz clic en "Ver Detalle" para ver todas las notas
                </p>
              </div>
            </mat-card-content>

            <mat-card-actions>
              <!-- Draft actions -->
              @if (canEdit(encounter)) {
              <button
                mat-button
                color="primary"
                (click)="editEncounter(encounter)"
              >
                <mat-icon>edit</mat-icon>
                Editar
              </button>
              <button
                mat-button
                color="accent"
                (click)="closeEncounter(encounter)"
              >
                <mat-icon>check_circle</mat-icon>
                Cerrar Atenci√≥n
              </button>
              }

              <!-- Closed actions -->
              @if (canAddAddendum(encounter)) {
              <button
                mat-button
                color="primary"
                (click)="addAddendum(encounter)"
              >
                <mat-icon>note_add</mat-icon>
                Agregar Addendum
              </button>
              } @if (!canEdit(encounter) && !canAddAddendum(encounter)) {
              <span class="no-actions-hint">Solo lectura</span>
              }
            </mat-card-actions>
          </mat-card>
          }
        </div>

        <!-- Pagination -->
        <mat-paginator
          [length]="totalItems()"
          [pageSize]="pageSize()"
          [pageIndex]="currentPage()"
          [pageSizeOptions]="[5, 10, 20]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        >
        </mat-paginator>
        }
      </div>
    </mat-tab>

    <!-- Tab: Medicamentos -->
    <mat-tab label="Medicamentos">
      <div class="tab-content">
        @if (patientProfileId()) {
        <app-professional-patient-medications-tab
          [patientProfileId]="+patientProfileId()!"
        />
        }
      </div>
    </mat-tab>

    <!-- Tab: Alergias -->
    <mat-tab label="Alergias">
      <div class="tab-content">
        @if (patientProfileId()) {
        <app-professional-patient-allergies-tab
          [patientProfileId]="+patientProfileId()!"
        />
        }
      </div>
    </mat-tab>

    <!-- Tab: Antecedentes -->
    <mat-tab label="Antecedentes">
      <div class="tab-content">
        @if (patientProfileId()) {
        <app-professional-patient-background-tab
          [patientProfileId]="+patientProfileId()!"
        />
        }
      </div>
    </mat-tab>

    <!-- Tab: Ex√°menes -->
    <mat-tab label="Ex√°menes">
      <div class="tab-content">
        @if (patientProfileId()) {
        <app-professional-patient-exams-tab
          [patientProfileId]="+patientProfileId()!"
        />
        }
      </div>
    </mat-tab>

    <!-- Tab: Resultados (Placeholder) -->
    <mat-tab label="Resultados">
      <div class="tab-content">
        <p class="placeholder-text">üèóÔ∏è Pr√≥ximamente: Resultados de ex√°menes</p>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
