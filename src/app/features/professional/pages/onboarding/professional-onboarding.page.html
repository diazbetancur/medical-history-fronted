<div class="onboarding-wrapper">
  <!-- Header -->
  <div class="onboarding-header">
    <div class="brand">
      <mat-icon class="brand-icon">medical_services</mat-icon>
      <span class="brand-text">MediTigo</span>
    </div>
    <h1 class="onboarding-title">Configura tu perfil profesional</h1>
    <p class="onboarding-subtitle">
      Completa tu información para comenzar a recibir pacientes
    </p>
  </div>

  <!-- Card form -->
  <mat-card class="onboarding-card">
    @if (loadingCatalogs()) {
    <div class="loading-state">
      <mat-spinner diameter="36"></mat-spinner>
      <span>Cargando datos...</span>
    </div>
    } @else {
    <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" novalidate>
      <div class="form-section photo-section">
        <div class="section-header">
          <mat-icon>photo_camera</mat-icon>
          <span>Foto de perfil</span>
        </div>

        <div class="photo-row">
          <div class="photo-preview">
            @if (profileImageUrl()) {
            <img [src]="profileImageUrl()!" alt="Foto de perfil" />
            } @else {
            <mat-icon>person</mat-icon>
            }
          </div>

          <div class="photo-actions">
            <input
              #photoInput
              type="file"
              accept="image/jpeg,image/png,image/webp"
              (change)="onPhotoSelected($event)"
              hidden
            />

            <button
              mat-stroked-button
              color="primary"
              type="button"
              [disabled]="isUploadingPhoto()"
              (click)="photoInput.click()"
            >
              <mat-icon>upload</mat-icon>
              Subir foto
            </button>

            <button
              mat-button
              color="warn"
              type="button"
              [disabled]="isUploadingPhoto() || !profileImageUrl()"
              (click)="removePhoto()"
            >
              <mat-icon>delete</mat-icon>
              Eliminar
            </button>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- ── Sección: Información principal ── -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>person</mat-icon>
          <span>Información principal</span>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nombre profesional / Consultorio *</mat-label>
          <mat-icon matPrefix>storefront</mat-icon>
          <input
            matInput
            formControlName="businessName"
            placeholder="Ej. Dr. Juan Pérez - Medicina Interna"
            autocomplete="organization"
          />
          <mat-hint>Cómo aparecerás en el directorio público</mat-hint>
          @if (profileForm.controls.businessName.hasError('required')) {
          <mat-error>Este campo es requerido</mat-error>
          } @if (profileForm.controls.businessName.hasError('maxlength')) {
          <mat-error>Máximo 200 caracteres</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Descripción / Presentación</mat-label>
          <mat-icon matPrefix>description</mat-icon>
          <textarea
            matInput
            formControlName="description"
            placeholder="Cuéntale a tus pacientes quién eres, tu experiencia y especialidad..."
            rows="4"
            autocomplete="off"
          ></textarea>
          <mat-hint>Opcional — hasta 2000 caracteres</mat-hint>
          @if (profileForm.controls.description.hasError('maxlength')) {
          <mat-error>Máximo 2000 caracteres</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- ── Sección: Ubicación ── -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>location_on</mat-icon>
          <span>Ubicación</span>
        </div>

        <div class="row-2">
          <mat-form-field appearance="outline">
            <mat-label>País *</mat-label>
            <mat-select formControlName="countryId">
              @for (country of countries(); track country.id) {
              <mat-option [value]="country.id">{{ country.name }}</mat-option>
              }
            </mat-select>
            @if (profileForm.controls.countryId.hasError('required')) {
            <mat-error>Selecciona un país</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Ciudad *</mat-label>
            <mat-select
              formControlName="cityId"
              [disabled]="!profileForm.controls.countryId.value"
            >
              @for (city of filteredCities(); track city.id) {
              <mat-option [value]="city.id">{{ city.name }}</mat-option>
              } @if (filteredCities().length === 0) {
              <mat-option disabled>Selecciona un país primero</mat-option>
              }
            </mat-select>
            @if (profileForm.controls.cityId.hasError('required')) {
            <mat-error>Selecciona una ciudad</mat-error>
            }
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Dirección del consultorio</mat-label>
          <mat-icon matPrefix>place</mat-icon>
          <input
            matInput
            formControlName="address"
            placeholder="Ej. Calle 80 # 45-23, Consultorio 301"
            autocomplete="street-address"
          />
          @if (profileForm.controls.address.hasError('maxlength')) {
          <mat-error>Máximo 500 caracteres</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- ── Sección: Contacto ── -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>contact_phone</mat-icon>
          <span>Contacto público</span>
        </div>

        <div class="row-2">
          <mat-form-field appearance="outline">
            <mat-label>Teléfono</mat-label>
            <mat-icon matPrefix>phone</mat-icon>
            <input
              matInput
              formControlName="phone"
              placeholder="+57 300 123 4567"
              type="tel"
              autocomplete="tel"
            />
            @if (profileForm.controls.phone.hasError('maxlength')) {
            <mat-error>Máximo 20 caracteres</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>WhatsApp</mat-label>
            <mat-icon matPrefix>chat</mat-icon>
            <input
              matInput
              formControlName="whatsApp"
              placeholder="+57 300 123 4567"
              type="tel"
              autocomplete="tel"
            />
            @if (profileForm.controls.whatsApp.hasError('maxlength')) {
            <mat-error>Máximo 20 caracteres</mat-error>
            }
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email profesional</mat-label>
          <mat-icon matPrefix>email</mat-icon>
          <input
            matInput
            formControlName="email"
            type="email"
            placeholder="consultorio@ejemplo.com"
            autocomplete="email"
          />
          <mat-hint>Se mostrará en tu perfil público</mat-hint>
          @if (profileForm.controls.email.hasError('email')) {
          <mat-error>Email inválido</mat-error>
          }
        </mat-form-field>
      </div>

      @if (hasExistingProfile()) {
      <mat-divider></mat-divider>

      <mat-tab-group
        class="profile-sections-tabs"
        [selectedIndex]="sectionsTab()"
        (selectedTabChange)="onSectionsTabChange($event.index)"
      >
        <mat-tab label="Especialidades">
          <div class="form-section nested-section">
            <div class="section-header">
              <mat-icon>workspace_premium</mat-icon>
              <span>Especialidades</span>
            </div>

            @if (sectionBusy() && !specialtiesLoaded()) {
            <div class="loading-state inline-loading">
              <mat-spinner diameter="24"></mat-spinner>
              <span>Cargando especialidades...</span>
            </div>
            } @else { @if (specialties().length > 0) {
            <mat-chip-set>
              @for (specialty of specialties(); track specialty.id) {
              <mat-chip>
                {{ specialty.name }}
                <button
                  mat-icon-button
                  type="button"
                  [disabled]="sectionBusy()"
                  (click)="removeSpecialty(specialty.id)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </mat-chip>
              }
            </mat-chip-set>
            } @else {
            <p class="empty-hint">Aún no tienes especialidades asignadas.</p>
            }

            <form
              class="inline-form"
              [formGroup]="specialtyProposalForm"
              (ngSubmit)="submitSpecialtyProposal()"
            >
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Proponer nueva especialidad</mat-label>
                <input
                  matInput
                  formControlName="name"
                  placeholder="Ej. Medicina del Sueño"
                />
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Justificación</mat-label>
                <textarea
                  matInput
                  formControlName="justification"
                  rows="2"
                  placeholder="Describe por qué debería incluirse"
                ></textarea>
              </mat-form-field>

              <button
                mat-stroked-button
                color="primary"
                type="submit"
                [disabled]="sectionBusy()"
              >
                Enviar propuesta
              </button>
            </form>

            @if (specialtyProposals().length > 0) {
            <div class="items-grid">
              @for (proposal of specialtyProposals(); track proposal.id) {
              <div class="item-card">
                <div class="item-title-row">
                  <strong>{{ proposal.name }}</strong>
                  <span class="status-chip">{{ proposal.status }}</span>
                </div>
                @if (proposal.justification) {
                <p>{{ proposal.justification }}</p>
                }
              </div>
              }
            </div>
            } }
          </div>
        </mat-tab>

        <mat-tab label="Formación">
          <div class="form-section nested-section">
            <div class="section-header">
              <mat-icon>school</mat-icon>
              <span>Formación</span>
            </div>

            @if (sectionBusy() && !educationLoaded()) {
            <div class="loading-state inline-loading">
              <mat-spinner diameter="24"></mat-spinner>
              <span>Cargando formación...</span>
            </div>
            } @else {
            <form
              class="inline-form"
              [formGroup]="educationForm"
              (ngSubmit)="saveEducation()"
            >
              <div class="row-2">
                <mat-form-field appearance="outline">
                  <mat-label>Institución *</mat-label>
                  <input
                    matInput
                    formControlName="institution"
                    placeholder="Ej. Universidad Nacional"
                  />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Título *</mat-label>
                  <input
                    matInput
                    formControlName="degree"
                    placeholder="Ej. Médico Cirujano"
                  />
                </mat-form-field>
              </div>

              <div class="row-2">
                <mat-form-field appearance="outline">
                  <mat-label>Tipo</mat-label>
                  <mat-select formControlName="educationType">
                    @for (type of educationTypeOptions; track type.value) {
                    <mat-option [value]="type.value"
                      >{{ type.label }}</mat-option
                    >
                    }
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>País</mat-label>
                  <input
                    matInput
                    formControlName="country"
                    placeholder="Ej. Colombia"
                  />
                </mat-form-field>
              </div>

              <div class="row-2">
                <mat-form-field appearance="outline">
                  <mat-label>Año inicio</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="startYear"
                    placeholder="Ej. 2016"
                  />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Año fin</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="endYear"
                    placeholder="Ej. 2021"
                  />
                </mat-form-field>
              </div>

              <div class="inline-actions">
                <button
                  mat-stroked-button
                  color="primary"
                  type="submit"
                  [disabled]="sectionBusy()"
                >
                  {{ editingEducationId() ? 'Actualizar formación' : 'Agregar
                  formación' }}
                </button>
                @if (editingEducationId()) {
                <button
                  mat-button
                  type="button"
                  (click)="cancelEducationEdit()"
                >
                  Cancelar
                </button>
                }
              </div>
            </form>

            @if (education().length > 0) {
            <div class="items-grid">
              @for (item of education(); track item.id) {
              <div class="item-card">
                <div class="item-title-row">
                  <strong>{{ item.degree }}</strong>
                  <span>{{ item.educationTypeName }}</span>
                </div>
                <p>{{ item.institution }}</p>
                <p class="muted">
                  {{ item.startYear ?? '—' }} - {{ item.endYear ?? 'Actual' }}
                  @if (item.country) { · {{ item.country }} }
                </p>

                <div class="inline-actions">
                  <button
                    mat-button
                    type="button"
                    (click)="editEducation(item)"
                  >
                    Editar
                  </button>
                  <button
                    mat-button
                    color="warn"
                    type="button"
                    (click)="deleteEducation(item.id)"
                  >
                    Eliminar
                  </button>

                  <input
                    #diplomaInput
                    type="file"
                    accept="application/pdf,image/jpeg,image/png"
                    hidden
                    (change)="onDiplomaSelected($event, item.id)"
                  />
                  <button
                    mat-button
                    type="button"
                    (click)="diplomaInput.click()"
                  >
                    Subir diploma
                  </button>

                  @if (item.hasDiploma) {
                  <button
                    mat-button
                    color="warn"
                    type="button"
                    (click)="deleteDiploma(item.id)"
                  >
                    Quitar diploma
                  </button>
                  }
                </div>
              </div>
              }
            </div>
            } @else {
            <p class="empty-hint">Aún no has agregado formación.</p>
            } }
          </div>
        </mat-tab>

        <mat-tab label="Sedes">
          <div class="form-section nested-section">
            <div class="section-header">
              <mat-icon>apartment</mat-icon>
              <span>Sedes</span>
            </div>

            @if (sectionBusy() && !locationsLoaded()) {
            <div class="loading-state inline-loading">
              <mat-spinner diameter="24"></mat-spinner>
              <span>Cargando sedes...</span>
            </div>
            } @else {
            <form
              class="inline-form"
              [formGroup]="locationForm"
              (ngSubmit)="saveLocation()"
            >
              <div class="row-2">
                <mat-form-field appearance="outline">
                  <mat-label>Nombre sede *</mat-label>
                  <input
                    matInput
                    formControlName="name"
                    placeholder="Ej. Sede Norte"
                  />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Teléfono</mat-label>
                  <input
                    matInput
                    formControlName="phone"
                    placeholder="Ej. +57 300 123 4567"
                  />
                </mat-form-field>
              </div>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Dirección</mat-label>
                <input
                  matInput
                  formControlName="address"
                  placeholder="Ej. Calle 80 #45-23"
                />
              </mat-form-field>

              <div class="row-2">
                <mat-form-field appearance="outline">
                  <mat-label>País *</mat-label>
                  <mat-select formControlName="countryId">
                    @for (country of countries(); track country.id) {
                    <mat-option [value]="country.id"
                      >{{ country.name }}</mat-option
                    >
                    }
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Ciudad *</mat-label>
                  <mat-select
                    formControlName="cityId"
                    [disabled]="!locationForm.controls.countryId.value"
                  >
                    @for (city of filteredLocationCities(); track city.id) {
                    <mat-option [value]="city.id">{{ city.name }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="inline-actions">
                <button
                  mat-stroked-button
                  color="primary"
                  type="submit"
                  [disabled]="sectionBusy()"
                >
                  {{ editingLocationId() ? 'Actualizar sede' : 'Agregar sede' }}
                </button>
                @if (editingLocationId()) {
                <button mat-button type="button" (click)="cancelLocationEdit()">
                  Cancelar
                </button>
                }
              </div>
            </form>

            @if (locations().length > 0) {
            <div class="items-grid">
              @for (location of locations(); track location.id) {
              <div class="item-card">
                <div class="item-title-row">
                  <strong>{{ location.name }}</strong>
                  @if (location.isDefault) {
                  <span class="status-chip">Principal</span>
                  }
                </div>
                <p>{{ location.cityName }}, {{ location.countryName }}</p>
                @if (location.address) {
                <p>{{ location.address }}</p>
                }

                <div class="inline-actions">
                  <button
                    mat-button
                    type="button"
                    (click)="editLocation(location)"
                  >
                    Editar
                  </button>
                  <button
                    mat-button
                    type="button"
                    [disabled]="location.isDefault"
                    (click)="setDefaultLocation(location.id)"
                  >
                    Marcar principal
                  </button>
                  <button
                    mat-button
                    color="warn"
                    type="button"
                    (click)="deleteLocation(location.id)"
                  >
                    Eliminar
                  </button>
                </div>
              </div>
              }
            </div>
            } @else {
            <p class="empty-hint">Aún no has agregado sedes.</p>
            } }
          </div>
        </mat-tab>
      </mat-tab-group>
      }

      <!-- ── Error banner ── -->
      @if (submitError()) {
      <div class="error-banner">
        <mat-icon>error_outline</mat-icon>
        <span>{{ submitError() }}</span>
      </div>
      }

      <!-- ── Actions ── -->
      <div class="form-actions">
        <button
          mat-flat-button
          color="primary"
          type="submit"
          [disabled]="isSubmitting()"
          class="submit-btn"
        >
          @if (isSubmitting()) {
          <mat-spinner diameter="20"></mat-spinner>
          <span>Creando perfil...</span>
          } @else {
          <ng-container>
            <mat-icon>rocket_launch</mat-icon>
            <span>Publicar mi perfil</span>
          </ng-container>
          }
        </button>
        <p class="terms-note">
          Al publicar tu perfil aceptas nuestros
          <a href="/terms" target="_blank">Términos y condiciones</a>. Podrás
          editarlo en cualquier momento desde tu panel.
        </p>
      </div>
    </form>
    }
  </mat-card>
</div>
