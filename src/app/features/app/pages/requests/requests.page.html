<div class="requests-page">
  <header>
    <h1>Solicitudes de Servicio</h1>
    <button mat-icon-button (click)="refresh()" [disabled]="store.loading()">
      <mat-icon>refresh</mat-icon>
    </button>
  </header>

  @if (store.loading() && store.requests().length === 0) {
  <div class="loading-state">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Cargando solicitudes...</p>
  </div>
  } @else if (store.error()) {
  <div class="error-state">
    <mat-icon>error_outline</mat-icon>
    <p>{{ store.error() }}</p>
    <button mat-raised-button color="primary" (click)="refresh()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </div>
  } @else {
  <mat-tab-group (selectedTabChange)="onTabChange($event.index)">
    <mat-tab label="Pendientes ({{ store.pendingCount() }})"></mat-tab>
    <mat-tab label="Contactados ({{ store.contactedCount() }})"></mat-tab>
    <mat-tab label="Cerradas ({{ store.closedCount() }})"></mat-tab>
    <mat-tab label="Todas ({{ store.totalCount() }})"></mat-tab>
  </mat-tab-group>

  <div class="requests-list">
    @for (request of filteredRequests(); track request.id) {
    <mat-card class="request-card">
      <mat-card-header>
        <mat-card-title>{{ request.clientName }}</mat-card-title>
        <mat-card-subtitle>
          @if (request.serviceName) { {{ request.serviceName }} • } {{
          formatDate(request.dateCreated) }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <p class="message">{{ request.message }}</p>

        <div class="contact-info">
          <span class="email">
            <mat-icon>email</mat-icon>
            {{ request.clientEmail }}
          </span>
          @if (request.clientPhone) {
          <span class="phone">
            <mat-icon>phone</mat-icon>
            {{ request.clientPhone }}
          </span>
          }
        </div>

        <mat-chip [class]="'status-' + request.status.toLowerCase()">
          {{ request.statusName }}
        </mat-chip>
      </mat-card-content>

      <mat-card-actions>
        @if (request.status === 'Pending') {
        <button mat-button color="primary" (click)="markAsContacted(request)">
          <mat-icon>phone_callback</mat-icon>
          Marcar Contactado
        </button>
        } @if (request.status === 'Contacted' || request.status ===
        'InProgress') {
        <button mat-button color="primary" (click)="markAsClosed(request)">
          <mat-icon>check_circle</mat-icon>
          Cerrar Solicitud
        </button>
        } @if (request.clientPhone) {
        <a mat-button [href]="'tel:' + request.clientPhone">
          <mat-icon>call</mat-icon>
          Llamar
        </a>
        }
        <a mat-button [href]="'mailto:' + request.clientEmail">
          <mat-icon>email</mat-icon>
          Email
        </a>
      </mat-card-actions>
    </mat-card>
    } @empty {
    <div class="empty-state">
      <mat-icon>inbox</mat-icon>
      <p>No hay solicitudes en esta categoría</p>
    </div>
    }
  </div>
  }
</div>
